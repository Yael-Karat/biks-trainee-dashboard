<mat-toolbar color="accent">
  <span style="margin-right: 8px;">Filter</span>
  <mat-form-field appearance="outline" style="flex: 1; max-width: 600px;">
    <input matInput (keyup)="applyFilter($event)" [(ngModel)]="filterValue"
           placeholder="Enter filter text (e.g., ID: IsraeliId , >80, <yyyy-mm-dd)">
  </mat-form-field>

  <span class="spacer"></span>

  <button mat-raised-button color="primary" (click)="addTrainee()" style="margin-left: 10px;">
    <mat-icon>person_add</mat-icon>
    Add
  </button>

  <button mat-stroked-button color="warn"
          [disabled]="!selection.hasValue()"
          (click)="removeSelectedTrainees()"
          style="margin-left: 5px;">
    <mat-icon>person_remove</mat-icon>
    Remove
  </button>
</mat-toolbar>

<mat-card>
  <mat-card-title>Trainee Test Results</mat-card-title>

  <div class="table-container">
    <table mat-table [dataSource]="dataSource" class="mat-elevation-z8">

      <!-- Select Checkbox -->
      <ng-container matColumnDef="select">
        <th mat-header-cell *matHeaderCellDef>
          <mat-checkbox
            (change)="masterToggle()"
            [checked]="isAllSelected()"
            [indeterminate]="selection.hasValue() && !isAllSelected()"
            aria-label="Select all rows">
          </mat-checkbox>
        </th>
        <td mat-cell *matCellDef="let row">
          <mat-checkbox
            (click)="$event.stopPropagation()"
            (change)="$event ? selection.toggle(row) : null"
            [checked]="selection.isSelected(row)"
            aria-label="Select row">
          </mat-checkbox>
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let element">
          <button mat-icon-button color="primary" (click)="selectTrainee(element)">
            <mat-icon>edit</mat-icon>
          </button>
        </td>
      </ng-container>

      <!-- Data Columns -->
      <ng-container matColumnDef="id">
        <th mat-header-cell *matHeaderCellDef>ID</th>
        <td mat-cell *matCellDef="let element">{{ element.id }}</td>
      </ng-container>

      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef>Name</th>
        <td mat-cell *matCellDef="let element">{{ element.name }}</td>
      </ng-container>

      <ng-container matColumnDef="subject">
        <th mat-header-cell *matHeaderCellDef>Subject</th>
        <td mat-cell *matCellDef="let element">{{ element.subject }}</td>
      </ng-container>

      <ng-container matColumnDef="grade">
        <th mat-header-cell *matHeaderCellDef>Grade</th>
        <td mat-cell *matCellDef="let element">{{ element.grade }}</td>
      </ng-container>

      <ng-container matColumnDef="date">
        <th mat-header-cell *matHeaderCellDef>Date</th>
        <td mat-cell *matCellDef="let element">{{ element.date }}</td>
      </ng-container>

      <!-- Header & Rows -->
      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"
          [class.selected-row]="selectedTrainee === row || (isNewTrainee && currentTempRow === row)">
      </tr>
    </table>

    <mat-paginator [pageSize]="10" showFirstLastButtons></mat-paginator>
  </div>
</mat-card>

<!-- Details Panel -->
<mat-card class="details-card" *ngIf="showDetails">
  <mat-card-title>Details Panel</mat-card-title>

  <form #traineeForm="ngForm" (ngSubmit)="saveTrainee(traineeForm)">
    <div class="details-form">

      <mat-form-field appearance="fill">
        <mat-label>ID (Israeli ID, 9 digits)</mat-label>
        <input matInput type="text"
               [(ngModel)]="editingTrainee.id"
               name="id"
               required
               appIsraeliId
               placeholder="Enter ID"
               #idInput="ngModel">
        <mat-error *ngIf="idInput.errors?.['required'] && idInput.touched">
          ID is required
        </mat-error>
        <mat-error *ngIf="idInput.errors?.['israeliId'] && idInput.touched">
          Invalid Israeli ID (checksum failed)
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label>Name</mat-label>
        <input matInput [(ngModel)]="editingTrainee.name" name="name"
               required placeholder="Enter name" #nameInput="ngModel">
        <mat-error *ngIf="nameInput.invalid && nameInput.touched">
          Name is required
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label>Date</mat-label>
        <input matInput type="date"
               [(ngModel)]="editingTrainee.date"
               name="date"
               max="{{todayDate()}}"
               required
               placeholder="Select date"
               title="Date"
               #dateInput="ngModel">
        <mat-error *ngIf="dateInput.invalid && dateInput.touched">
          Date is required and must not be in the future
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label>Grade (0-100)</mat-label>
        <input matInput type="number"
               [(ngModel)]="editingTrainee.grade"
               name="grade"
               required min="0" max="100"
               placeholder="Enter grade"
               #gradeInput="ngModel">
        <mat-error *ngIf="gradeInput.invalid && gradeInput.touched">
          Grade must be between 0 and 100
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label>Subject</mat-label>
        <input matInput [(ngModel)]="editingTrainee.subject" name="subject"
               required placeholder="Enter subject" #subjectInput="ngModel">
        <mat-error *ngIf="subjectInput.invalid && subjectInput.touched">
          Subject is required
        </mat-error>
      </mat-form-field>

      <div class="actions">
        <button mat-raised-button color="primary" type="submit" [disabled]="!traineeForm.form.valid">Save</button>
        <button mat-stroked-button color="warn" type="button" (click)="cancelEdit()">Cancel</button>
      </div>
    </div>
  </form>
</mat-card>
