<div class="analysis-root mat-elevation-z2">
  <!-- Filters Card (Always Visible) -->
  <mat-card class="filters-card">
    <mat-card-title>Filters</mat-card-title>
    <mat-card-content>
      <div class="filters-row">
        <!-- IDs selector -->
        <mat-form-field class="filter-field ids-field" appearance="outline">
        <mat-label>Trainee IDs</mat-label>
        <mat-select 
          [(ngModel)]="selectedTrainees" 
          multiple 
          (selectionChange)="updateCharts()"
          placeholder="Select IDs to filter">
          <mat-select-trigger>
            <span *ngIf="selectedTrainees.length === 0" class="placeholder-text">
              Show All IDs
            </span>
            <span *ngIf="selectedTrainees.length > 0" class="selected-text">
              {{ selectedTrainees.join(', ') }}
            </span>
          </mat-select-trigger>
          <!-- Deduplicate trainees by ID -->
          <mat-option 
            *ngFor="let trainee of trainees | uniqueById" 
            [value]="trainee.id">
            ID: {{ trainee.id }} - {{ trainee.name }}
          </mat-option>
        </mat-select>
        <button 
          mat-icon-button 
          matSuffix 
          *ngIf="selectedTrainees.length > 0"
          (click)="clearIds(); $event.stopPropagation()"
          type="button"
          title="Clear all selections"
          aria-label="Clear selection">
          <span style="font-size: 18px;">✕</span>
        </button>
      </mat-form-field>

        <!-- Subjects selector -->
        <mat-form-field class="filter-field subjects-field" appearance="outline">
          <mat-label>Subjects</mat-label>
          <mat-select 
            [(ngModel)]="selectedSubjects" 
            multiple 
            (selectionChange)="updateCharts()"
            placeholder="Select subjects to filter">
            <mat-select-trigger>
              <span *ngIf="selectedSubjects.length === 0" class="placeholder-text">
                Show All Subjects
              </span>
              <span *ngIf="selectedSubjects.length > 0" class="selected-text">
                {{ selectedSubjects.join(', ') }}
              </span>
            </mat-select-trigger>
            <mat-option *ngFor="let subject of subjects" [value]="subject">
              {{ subject }}
            </mat-option>
          </mat-select>
          <button 
            mat-icon-button 
            matSuffix 
            *ngIf="selectedSubjects.length > 0"
            (click)="clearSubjects(); $event.stopPropagation()"
            type="button"
            title="Clear all selections"
            aria-label="Clear selection">
            <span style="font-size: 18px;">✕</span>
          </button>
        </mat-form-field>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Charts Section -->
  <mat-card class="charts-card">
    <mat-card-title>Charts</mat-card-title>
    <mat-card-content>
      <div class="charts-grid" cdkDropList cdkDropListOrientation="horizontal" (cdkDropListDropped)="drop($event)">
        <!-- Chart 1 -->
        <div class="chart-card" cdkDrag>
          <h3 class="chart-title">{{ charts[0]?.title || 'Chart 1: Grades over time (per student)' }}</h3>
          <div class="chart-container">
            <canvas
              *ngIf="charts[0]"
              baseChart
              [type]="charts[0].type"
              [data]="charts[0].data"
              [options]="charts[0].options"
            ></canvas>
            <div *ngIf="!charts[0]" class="no-data">
              <p>No data available</p>
            </div>
          </div>
        </div>

        <!-- Chart 3 (formerly Chart 2 visible) -->
        <div class="chart-card" cdkDrag>
          <h3 class="chart-title">{{ charts[1]?.title || 'Chart 3: Grades averages per subject' }}</h3>
          <div class="chart-container">
            <canvas
              *ngIf="charts[1]"
              baseChart
              [type]="charts[1].type"
              [data]="charts[1].data"
              [options]="charts[1].options"
            ></canvas>
            <div *ngIf="!charts[1]" class="no-data">
              <p>No data available</p>
            </div>
          </div>
        </div>

      </div>

      <!-- Hidden Chart (Chart 2: Averages for chosen IDs) -->
      <div class="hidden-chart-section">
        <h3 class="chart-title">{{ hiddenChart?.title || 'Chart 2: Student averages for students with chosen ID' }}</h3>
        <div class="chart-container">
          <canvas
            *ngIf="hiddenChart"
            baseChart
            [type]="hiddenChart.type"
            [data]="hiddenChart.data"
            [options]="hiddenChart.options"
          ></canvas>
          <div *ngIf="!hiddenChart" class="no-data">
            <p>No data available</p>
          </div>
        </div>
      </div>

      <!-- Swap Button -->
      <div class="swap-button-container">
        <button 
          mat-raised-button 
          color="accent" 
          (click)="swapHiddenChart()"
          [disabled]="!hiddenChart || !charts[1]">
          <span>⇄</span> Swap Chart 3 with Hidden Chart 2
        </button>
      </div>
    </mat-card-content>
  </mat-card>
</div>